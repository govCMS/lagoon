#!/usr/bin/env bash
##
# GovCMS 8 Drupal deployment script.
#

# Ensure placeholders are replaced in Drush9 alias file.
sed -i "s/%%PROJECT_NAME%%/$LAGOON_PROJECT/g" /app/drush/sites/govcms.site.yml

# Ensure tmp folder always exists.
mkdir -p /app/web/sites/default/files/private/tmp/

# Check for presence of config files.
config_count=`ls -1 /app/config/default/*.yml 2>/dev/null | wc -l`
dev_config_count=`ls -1 /app/config/dev/*.yml 2>/dev/null | wc -l`

# Configuration import function.
common_setup () {
  # Ensure updates run prior to configuration import.
  drush updb -y
  drush cr

  # Base configuration import with development environment overrides.
  if [ "$config_count" -gt 0 ]; then
    drush cim -y sync
    if [[ ! -z "$LAGOON_ENVIRONMENT_TYPE" && "$LAGOON_ENVIRONMENT_TYPE" != "production" && "$dev_config_count" -gt 0 ]]; then
      drush cim -y dev --partial
    fi
  fi

  if [[ ! -z "$LAGOON_ENVIRONMENT_TYPE" && "$LAGOON_ENVIRONMENT_TYPE" != "production" ]]; then
    # Enable stage file proxy post db-import.
    drush en stage_file_proxy -y
  fi
}

# Non production environments.
if [[ "$LAGOON_ENVIRONMENT_TYPE" != "production" ]]; then
    if ! drush status --fields=bootstrap | grep -q "Successful"; then
        # Import prod db in Lagoon development environments.
        if [[ ! -z "$LAGOON_ENVIRONMENT_TYPE" && "$LAGOON_ENVIRONMENT_TYPE" != "local" ]]; then
          drush sql-sync @govcms-prod @self -y
          common_setup
        else
          echo "Drupal not installed."
        fi
    else
      common_setup
    fi
# Production environments.
else
  if drush status --fields=bootstrap | grep -q "Successful"; then
    mkdir -p /app/web/sites/default/files/private/backups/ && drush sql-dump --ordered-dump --gzip --result-file=/app/web/sites/default/files/private/backups/pre-deploy-dump.sql
    common_setup
    drush en -y govcms_lagoon && drush pmu -y govcms_lagoon;
  else
    echo "Drupal not installed."
  fi
fi
